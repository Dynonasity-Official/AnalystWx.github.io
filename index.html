<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>AnalystWx</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        #map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }
        
        .panel {
            position: fixed;
            top: 8px;
            left: 8px;
            padding: 20px;
            width: 680px;
            height: 85px;
            border-radius: 15px;
            background: linear-gradient(to bottom, #1E90FF, #ADD8E6);
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        h2 {
            margin-top: 0px;
        }
        
        .blue-button {
            background-color: #1E90FF;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            margin-top: 0px;
            margin-right: 5px;
        }
        
        .blue-button:hover {
            background-color: #187bcd;
        }

        .blue-button.active {
            background-color: #0066cc;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .radar-marker:hover div {
            transform: scale(1.2);
            transition: transform 0.2s;
        }

        #debugInfo {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            max-width: 300px;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="panel">
        <h2>AnalystWX</h2>
        <button class="blue-button" id="compositeBtn" onclick="CompositeReflectivityFunction()">            
            Composite
        </button>
        <button class="blue-button" id="brBtn" onclick="BrFunction()">            
            BR (L3)
        </button>
        <button class="blue-button" id="bvBtn" onclick="BvFunction()">            
            BV (L3)
        </button>
        <button class="blue-button" id="l2Btn" onclick="Level2Function()">            
            L2 Data
        </button>
    </div>

    <div id="debugInfo"></div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { minZoom: 4, maxZoom: 19 }).setView([37.0902, -95.7129], 4);

        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{x}/{y}', {
            attribution: '© Esri', maxZoom: 19, minZoom: 4
        }).addTo(map);

        const boundaries = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png', {
            attribution: '© CartoDB'
        }).addTo(map);

        let radarLayer = null;
        let siteRadarLayer = null;
        let selectedSite = null;
        let selectedMarker = null;

        // Radar sites (truncated for brevity)
        const radarSites = [
            { name: 'KABR', lat: 45.4558, lon: -98.4132, city: 'Aberdeen, SD' },
            { name: 'KABX', lat: 35.1497, lon: -106.8239, city: 'Albuquerque, NM' },
            { name: 'KAKQ', lat: 36.9840, lon: -77.0075, city: 'Norfolk, VA' }
            // ... add the rest
        ];

        const radarIcon = L.divIcon({
            className: 'radar-marker',
            html: `<div style="background-color: #FF0000; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.5); cursor: pointer;"></div>`,
            iconSize: [16, 16]
        });

        const selectedRadarIcon = L.divIcon({
            className: 'radar-marker-selected',
            html: `<div style="background-color: #00FF00; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 6px rgba(0,0,0,0.7); cursor: pointer;"></div>`,
            iconSize: [20, 20]
        });

        radarSites.forEach(site => {
            const marker = L.marker([site.lat, site.lon], { icon: radarIcon })
                .bindPopup(`<b>${site.name}</b><br>${site.city}<br><small>Click to select</small>`)
                .addTo(map);

            marker.on('click', function() {
                if (selectedMarker) selectedMarker.setIcon(radarIcon);
                selectedSite = site;
                selectedMarker = marker;
                marker.setIcon(selectedRadarIcon);
                updateSelectedSiteDisplay();
            });

            site.marker = marker;
        });

        function updateSelectedSiteDisplay() {
            let display = document.getElementById('selectedSite');
            if (!display) {
                display = document.createElement('div');
                display.id = 'selectedSite';
                display.style.cssText = `position: fixed; top: 115px; left: 8px; padding: 10px 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); z-index: 1000; font-size: 14px; font-weight: 600;`;
                document.body.appendChild(display);
            }
            if (selectedSite) {
                display.innerHTML = `<strong>Selected:</strong> ${selectedSite.name} - ${selectedSite.city}`;
                display.style.display = 'block';
            } else {
                display.style.display = 'none';
            }
        }

        function debugLog(message) {
            const debug = document.getElementById('debugInfo');
            debug.style.display = 'block';
            debug.innerHTML += message + '<br>';
            console.log(message);
        }

        // ========================
        // FIXED TILE LAYERS
        // ========================

        function CompositeReflectivityFunction() {
            const btn = document.getElementById('compositeBtn');
            if (radarLayer) {
                map.removeLayer(radarLayer);
                radarLayer = null;
                btn.classList.remove('active');
            } else {
                radarLayer = L.tileLayer(`https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-900913/{z}/{x}/{y}.png`, {
                    attribution: 'NEXRAD via Iowa Environmental Mesonet',
                    opacity: 0.6,
                    minZoom: 4,
                    maxZoom: 10,
                    tms: false
                }).addTo(map);
                btn.classList.add('active');
                debugLog('Composite reflectivity loaded (Level 3)');
            }
        }

        function BrFunction() {
            const btn = document.getElementById('brBtn');
            if (!selectedSite) return alert("Please click on a radar site first!");
            if (siteRadarLayer) {
                map.removeLayer(siteRadarLayer);
                siteRadarLayer = null;
                btn.classList.remove('active');
                document.getElementById('bvBtn').classList.remove('active');
                document.getElementById('l2Btn').classList.remove('active');
            } else {
                const radarCode = selectedSite.name.substring(1);
                siteRadarLayer = L.tileLayer(`https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/ridge::${radarCode}-N0Q-0-900913/{z}/{x}/{y}.png`, {
                    attribution: `${selectedSite.name} Base Reflectivity (Level 3)`,
                    opacity: 0.8,
                    minZoom: 5,
                    maxZoom: 10,
                    tms: false
                }).addTo(map);
                btn.classList.add('active');
                document.getElementById('bvBtn').classList.remove('active');
                document.getElementById('l2Btn').classList.remove('active');
                map.setView([selectedSite.lat, selectedSite.lon], 8);
                debugLog(`BR loaded for ${selectedSite.name} (Level 3 - N0Q)`);
            }
        }

        function BvFunction() {
            const btn = document.getElementById('bvBtn');
            if (!selectedSite) return alert("Please click on a radar site first!");
            if (siteRadarLayer) {
                map.removeLayer(siteRadarLayer);
                siteRadarLayer = null;
                btn.classList.remove('active');
                document.getElementById('brBtn').classList.remove('active');
                document.getElementById('l2Btn').classList.remove('active');
            } else {
                const radarCode = selectedSite.name.substring(1);
                siteRadarLayer = L.tileLayer(`https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/ridge::${radarCode}-N0S-0-900913/{z}/{x}/{y}.png`, {
                    attribution: `${selectedSite.name} Storm Velocity (Level 3)`,
                    opacity: 0.8,
                    minZoom: 5,
                    maxZoom: 10,
                    tms: false
                }).addTo(map);
                btn.classList.add('active');
                document.getElementById('brBtn').classList.remove('active');
                document.getElementById('l2Btn').classList.remove('active');
                map.setView([selectedSite.lat, selectedSite.lon], 8);
                debugLog(`BV loaded for ${selectedSite.name} (Level 3 - N0S)`);
            }
        }

        function Level2Function() {
            const btn = document.getElementById('l2Btn');
            if (!selectedSite) return alert("Please click on a radar site first!");
            if (siteRadarLayer) {
                map.removeLayer(siteRadarLayer);
                siteRadarLayer = null;
                btn.classList.remove('active');
                document.getElementById('brBtn').classList.remove('active');
                document.getElementById('bvBtn').classList.remove('active');
            } else {
                const radarCode = selectedSite.name.substring(1);
                siteRadarLayer = L.tileLayer(`https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/ridge::${radarCode}-N0Q-0-900913/{z}/{x}/{y}.png`, {
                    attribution: `${selectedSite.name} Super-Res (Higher Quality)`,
                    opacity: 0.9,
                    minZoom: 5,
                    maxZoom: 10,
                    tms: false
                }).addTo(map);
                btn.classList.add('active');
                document.getElementById('brBtn').classList.remove('active');
                document.getElementById('bvBtn').classList.remove('active');
                map.setView([selectedSite.lat, selectedSite.lon], 9);
                debugLog(`Level 2 quality data loaded for ${selectedSite.name}`);
                debugLog(`Note: This is Super-Res Level 3, not true Level 2`);
            }
        }

        // Auto-refresh
        setInterval(() => {
            if (radarLayer) {
                const btn = document.getElementById('compositeBtn');
                btn.click();
                setTimeout(() => btn.click(), 100);
                debugLog('Auto-refreshed composite radar');
            }
            if (siteRadarLayer) {
                ['brBtn','bvBtn','l2Btn'].forEach(id => {
                    const b = document.getElementById(id);
                    if (b.classList.contains('active')) {
                        b.click();
                        setTimeout(() => b.click(), 100);
                    }
                });
                debugLog('Auto-refreshed site radar');
            }
        }, 120000);

    </script>
</body>
</html>
